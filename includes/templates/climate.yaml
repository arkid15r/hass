- binary_sensor:
    - name: HVAC Is Cooling
      unique_id: hvac_is_cooling
      state: >
        {{ not is_state('climate.thermostat', 'off') and
           state_attr('climate.thermostat', 'hvac_action') in ['cooling'] and
           'compCool1' in state_attr('climate.thermostat', 'equipment_running')
        }}

    - name: HVAC Has Been Turned Off
      unique_id: hvac_has_been_turned_off
      state: >
        {{ is_state('binary_sensor.hvac_is_running', 'off') and
           as_timestamp(now()) - as_timestamp(
            states.binary_sensor.hvac_is_running.last_changed) <= 60 * 5
        }}

    - name: HVAC Is Heating
      unique_id: hvac_is_heating
      state: >
        {{ not is_state('climate.thermostat', 'off') and
           state_attr('climate.thermostat', 'hvac_action') in ['heating'] and
           'auxHeat1' in state_attr('climate.thermostat', 'equipment_running')
        }}

    - name: HVAC Is Running
      unique_id: hvac_is_running
      state: >
        {{ is_state('binary_sensor.hvac_is_cooling', 'on') or
           is_state('binary_sensor.hvac_is_heating', 'on')
        }}

    - name: Indoor Temperature Higher
      unique_id: indoor_temperature_higher
      state: >
        {{ states('sensor.indoor_temperature') | int >
            states('sensor.outdoor_temperature') | int
        }}

    - name: Indoor Temperature 2 Degree Higher
      unique_id: indoor_temperature_2_degree_higher
      state: >
        {{ states('sensor.indoor_temperature') | int >
            states('sensor.outdoor_temperature') | int + 2
        }}

  sensor:
    - name: Corridor Temperature
      unique_id: corridor_temperature
      state: >
        {{ state_attr('climate.thermostat', 'current_temperature') | round }}

    - name: HVAC Preset Mode
      unique_id: hvac_preset_mode
      state: >
        {{ state_attr('climate.thermostat', 'preset_mode') }}

    - name: Indoor Temperature
      unique_id: indoor_temperature
      state: >
        {{ expand('group.indoor_temperature') |
            rejectattr('state', 'in', ('unavailable',)) |
            map(attribute='state') |
            map('float') |
            average |
            round
        }}

    - name: Thermal Perimeter Breached
      unique_id: thermal_perimeter_breached
      state: >
        {{ expand(state_attr('binary_sensor.thermal_perimeter', 'entity_id')) |
            selectattr('state', 'eq', 'on') |
            list |
            count > 0
        }}
      attributes:
        template: climate
        areas: >
          {{ expand(state_attr(
              'binary_sensor.thermal_perimeter', 'entity_id')) |
                  selectattr('state', 'eq', 'on') |
                  map(attribute='entity_id') |
                  map('area_name') |
                  reject('eq', none) |
                  unique |
                  sort
          }}
        area_summary: >
          {% set entities = expand(state_attr(
              'binary_sensor.thermal_perimeter', 'entity_id')) |
                  selectattr('state', 'eq', 'on') |
                  map(attribute='entity_id') |
                  map('area_name') |
                  reject('eq', none) |
                  unique |
                  sort
          %}
          {{- entities[0] if entities | count <= 1 else
              (entities[:-1] | join(', '), 'and', entities[-1]) | join(' ')
          }}
        entities: >
          {{ expand(state_attr(
              'binary_sensor.thermal_perimeter', 'entity_id')) |
                  selectattr('state', 'eq', 'on') |
                  map(attribute='entity_id') |
                  sort
          }}
        entities_summary: >
          {% set entities = expand(
              state_attr('binary_sensor.thermal_perimeter', 'entity_id')) |
                  selectattr('state', 'eq', 'on') |
                  map(attribute='name') |
                  unique |
                  sort
          %}
          {{- entities[0] if entities | count <= 1 else
              (entities[:-1] | join(', '), 'and', entities[-1]) | join(' ')
          }}
